import React, { useEffect, useState, useCallback } from 'react';
import { View, Text, FlatList, TouchableOpacity, RefreshControl, Alert } from 'react-native';
import { supabase } from '../../lib/supabase';

type Row = {
  id: number;
  tmdb_id: number;
  media_type: 'movie' | 'tv';
  title: string | null;
  name: string | null;
  release_date: string | null;
  first_air_date: string | null;
  created_at: string;
};

export default function InboxScreen() {
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(false);

  const load = useCallback(async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('inbox')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) throw error;
      setRows(data ?? []);
    } catch (e: any) {
      Alert.alert('Load failed', e?.message ?? String(e));
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    load();
  }, [load]);

  async function remove(tmdb_id: number) {
    try {
      const { error } = await supabase.from('inbox').delete().eq('tmdb_id', tmdb_id);
      if (error) throw error;
      setRows((r) => r.filter((x) => x.tmdb_id !== tmdb_id));
    } catch (e: any) {
      Alert.alert('Delete failed', e?.message ?? String(e));
    }
  }

  return (
    <View style={{ flex: 1, padding: 16 }}>
      <FlatList
        data={rows}
        refreshControl={<RefreshControl refreshing={loading} onRefresh={load} />}
        keyExtractor={(it) => String(it.id)}
        renderItem={({ item }) => (
          <View style={{ paddingVertical: 10, borderBottomWidth: 1, borderBottomColor: '#333' }}>
            <Text style={{ color: '#fff' }}>
              {(item.title || item.name || 'Untitled')} ·{' '}
              {(item.release_date || item.first_air_date || '').slice(0, 4)} · {item.media_type.toUpperCase()}
            </Text>
            <TouchableOpacity onPress={() => remove(item.tmdb_id)}>
              <Text style={{ color: '#f66', marginTop: 4 }}>Remove</Text>
            </TouchableOpacity>
          </View>
        )}
        ListEmptyComponent={
          <Text style={{ color: '#777', paddingTop: 24 }}>
            Nothing saved yet. Search and tap an item to add it.
          </Text>
        }
      />
    </View>
  );
}
